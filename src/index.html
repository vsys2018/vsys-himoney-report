<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/style.css" type="text/css" />
  </head>

  <body>
    <div class="col-sm-12" style="margin-top: 15px;">
      <div class="panel panel-default panel-table">
        <div class="panel-heading">Thống kê nạp tiền</div>
        <div class="panel-body">
          <div class="table-filter">
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-01-from">
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-01-to">
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div>Tổng cộng: <span id="table1-sum">0</span></div>
          </div>

          <div class="table-responsive">
            <table
              id="table1"
              class="table table-striped table-hover table-fw-widget"
              style="width: 100%"
            >
              <thead style="width: 100%">
                <tr>
                  <th>Địa điểm</th>
                  <th>Thời gian</th>
                  <th>ID Thẻ</th>
                  <th>Tên nhân viên</th>
                  <th>Số điện thoại</th>
                  <th>Lý do nạp tiền</th>
                  <th>Tiền nạp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="panel panel-default panel-table">
        <div class="panel-heading">Thống kê rút tiền</div>
        <div class="panel-body">
          <div class="table-filter">
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-02-from">
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-02-to">
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div>Tổng cộng: <span id="table2-sum">0</span></div>
          </div>
          <div class="table-responsive">
            <table
              id="table2"
              class="table table-striped table-hover table-fw-widget"
              style="width: 100%"
            >
              <thead style="width: 100%">
                <tr>
                  <th>Địa điểm</th>
                  <th>Thời gian</th>
                  <th>Thao tác</th>
                  <th>Tổng tiền lấy ra</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
    <script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.12/api/sum().js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        Array.prototype.sum = function(prop) {
          var total = 0;
          for (var i = 0, _len = this.length; i < _len; i++) {
            total += this[i][prop];
          }
          return total;
        };

        const formatter = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" });

        const beginMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        const currentTime = new Date();

        const id = "<%= data %>".split("-");
        let filterquery = [];
        id.forEach(i => filterquery.push({ c8: i }));

        $("#dtp-01-from").datetimepicker({ locale: "vi", defaultDate: beginMonth });
        $("#dtp-01-to").datetimepicker({ locale: "vi", defaultDate: currentTime });

        $("#dtp-02-from").datetimepicker({ locale: "vi", defaultDate: beginMonth });
        $("#dtp-02-to").datetimepicker({ locale: "vi", defaultDate: currentTime });

        let data1 = [];

        const table1 = $("#table1").dataTable({
          buttons: ["copy", "excel", "pdf", "print"],
          pageLength: 10,
          lengthMenu: [[6, 10, 25, 50, -1], [6, 10, 25, 50, "All"]],
          dom:
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>",
          data: data1,
          columns: [
            { data: "c7" },
            { data: "t" },
            { data: "c2" },
            { data: "c3" },
            { data: "c4" },
            { data: "c5" },
            {
              data: "c1",
              render: (data, type, row) => {
                return formatter.format(data);
              }
            }
          ],
          processing: true
        });

        const table2 = $("#table2").dataTable({
          buttons: ["copy", "excel", "pdf", "print"],
          pageLength: 10,
          lengthMenu: [[6, 10, 25, 50, -1], [6, 10, 25, 50, "All"]],
          dom:
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>",
          data: data1,
          columns: [{ data: "c1" }, { data: "t" }, { data: "c2" }, { data: "c3" }]
        });

        fetch("/api/naptien01", {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          redirect: "follow",
          referrer: "no-referrer",
          body: JSON.stringify({
            fromdate: beginMonth.toISOString(),
            todate: currentTime.toISOString(),
            filter: filterquery
          })
        })
          .then(res => {
            return res.json();
          })
          .then(res => {
            if (res.length > 0) {
              // Update table
              table1.fnClearTable();
              table1.fnAddData(res);
              let sum = res.sum("c1");
              $("#table1-sum").text(formatter.format(sum));
            }
          });
      });
    </script>
  </body>
</html>
